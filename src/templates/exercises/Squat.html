<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      html, body {
    margin: 0;
    padding: 0;
  }
  canvas {
    display: block;
            margin: auto;
            position: fixed;
            top: 1%;
            bottom: 0;
            left: 0;
            right:45%;
            border: 4px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%; /* Adjust width as desired */
            height: 80%; /* Adjust height as desired */
        }
    .button-container {
        position: fixed;
        bottom: 45px; /* Adjust bottom position as needed */
        left: 25%; /* Center horizontally */
        transform: translateX(-50%);
    }

    .button-container button {
        padding: 10px 30px; /* Increase padding to make the button bigger */
        font-size: 24px; /* Increase font size to make the text bigger */
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .button-container button:hover {
        background-color: #0056b3;
    }
    #startStopButton {
        margin-right: 20px; /* Add margin on the right side of the Start/Stop button */
    }

    #resetButton {
        margin-left: 60px; /* Add margin on the left side of the Reset button */
    }
      
    </style>
    <div class="button-container">
      <!-- <button id="startStopButton">Start/Stop</button> -->
      <button id="resetButton">Reset</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <!-- Require the peer dependencies of pose-detection. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>

<!-- You must explicitly require a TF.js backend if you're not using the TF.js union bundle. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<!-- Alternatively you can use the WASM backend: <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm/dist/tf-backend-wasm.js"></script> -->

<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script> -->
    
    <meta charset="utf-8" />

  </head>
  <body>
    <h1 style="position: fixed; top: 0px; right: 850px; font-size: 48px;background-color: #f0f0f0; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">Squat Exercise</h1>

    <img src="https://www.inspireusafoundation.org/wp-content/uploads/2021/06/bodyweight-squat.gif" style="position: fixed; top: 60px; right: 340px; width: 400px;">

    <div id="exerciseSteps" style="position: fixed; top: 450px; right: 70px; background-color: #f0f0f0; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); height: 365px; font-size: 18px; line-height: 1.6;">
      <h2 style="margin-bottom: 15px;">Steps To Perform Squat Exercise:</h2>
      <ol style="padding-left: 20px;">
        <li>Stand with feet shoulder-width apart, toes slightly turned out, and chest up.</li>
        <li>Engage your core muscles to stabilize your spine throughout the movement.</li>
        <li>Keep your weight in your heels as you lower your body as if sitting back on a chair.</li>
        <li>Bend at your knees and hips simultaneously, lowering your hips towards the ground.</li>
        <li>Keep your chest lifted and back straight, avoiding rounding or arching your spine.</li>
        <li>Lower yourself until your thighs are parallel to the ground, or as low as your mobility allows.</li>
        <li>Press through your heels to drive yourself back up to the starting position.</li>
        <li>Squeeze your glutes at the top of the movement to fully extend your hips.</li>
        <li>Keep your knees in line with your toes throughout the movement, avoiding inward collapsing.</li>
        <li>Repeat for the desired number of repetitions, focusing on controlled movements and maintaining proper form.</li>
      </ol>
    </div>
    
    <script>
      let detector;
      let detectorConfig;
      let poses;
      let video;
      let skeleton = true;
      let model;
      let leftAngle = 0;
      let rightAngle = 0;
      let leftKneeAngle = 0;
      let rightKneeAngle = 0;
      let reps = 0;
      let upPosition = false;
      let downPosition = false;
      let highlightHip = false;
      let kneeWarningGiven = false;
      let currentFPS = 0;
      let canvasWidth = 960; 
      let canvasHeight = 720; 
      let scaleFactorX, scaleFactorY;

      async function init() {
        detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_THUNDER };
        detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);
        edges = {
          '5,7': 'm',
          '7,9': 'm',
          '6,8': 'c',
          '8,10': 'c',
          '5,6': 'y',
          '5,11': 'm',
          '6,12': 'c',
          '11,12': 'y',
          '11,13': 'm',
          '13,15': 'm',
          '12,14': 'c',
          '14,16': 'c'
        };
        await getPoses();
      }

      async function videoReady() {
        //console.log('video ready');
        scaleFactorX = canvasWidth / video.width;
        scaleFactorY = canvasHeight / video.height;
      }

      async function setup() {
        var msg = new SpeechSynthesisUtterance('Loading, please wait...');
        window.speechSynthesis.speak(msg);
        createCanvas(canvasWidth, canvasHeight);
        video = createCapture(VIDEO, videoReady);
        //video.size(960, 720);
        video.hide()
        await init();
      }

      async function getPoses() {
        poses = await detector.estimatePoses(video.elt);
        setTimeout(getPoses, 0);
        //console.log(poses);
      }

      function draw() {
        background(220);
        translate(width, 0);
        scale(-1, 1);
        image(video, 0, 0, canvasWidth, canvasHeight);

        // Draw keypoints and skeleton
        drawKeypoints();
        if (skeleton) {
          drawSkeleton();
        }

        // Calculate and display FPS
        currentFPS = frameRate(); // Get the current FPS
        fill(255);
        textSize(20);
        // text(`FPS: ${currentFPS.toFixed(2)}`, 20, 20); // Display the FPS on the screen
        push();
        translate(width, 0);
        scale(-1, 1);
        text(`FPS: ${currentFPS.toFixed(2)}`, 20, 20); // Display the FPS on the screen
        pop();
        
        // Write text
        fill(255);
        strokeWeight(2);
        stroke(51);
        translate(width, 0);
        scale(-1, 1);
        textSize(60);

        if (poses && poses.length > 0) {
          let pushupString = `Reps Completed: ${reps}`;
          text(pushupString, 220, 700);
        }
        else {
          text('Loading, please wait...', 180, 700);
        }
        
      }

      function drawKeypoints() {
        var count = 0;
        if (poses && poses.length > 0) {
          for (let kp of poses[0].keypoints) {
            const { x, y, score } = kp;
            if (score > 0.3) {
              count = count + 1;
              fill(255);
              stroke(0);
              strokeWeight(4);
              circle(x * scaleFactorX, y * scaleFactorY, 16);
            }
            // if (count == 17) {
            //   //console.log('Whole body visible!');
            // }
            else {
              //console.log('Not fully visible!');
            }
            updateHipAngle();
            updateKneeAngle();
            inUpPosition();
            inDownPosition();
          }
        }
      }

      // Draws lines between the keypoints
      function drawSkeleton() {
        confidence_threshold = 0.5;
          // Adjust skeleton lines based on scale factors
          if (poses && poses.length > 0) {
              for (const [key, value] of Object.entries(edges)) {
                  const p = key.split(",");
                  const p1 = p[0];
                  const p2 = p[1];

                  const y1 = poses[0].keypoints[p1].y * scaleFactorY;
                  const x1 = poses[0].keypoints[p1].x * scaleFactorX;
                  const c1 = poses[0].keypoints[p1].score;
                  const y2 = poses[0].keypoints[p2].y * scaleFactorY;
                  const x2 = poses[0].keypoints[p2].x * scaleFactorX;
                  const c2 = poses[0].keypoints[p2].score;

                  if ((c1 > confidence_threshold) && (c2 > confidence_threshold)) {
                      if ((highlightHip == true) && ( p[0] == '11' || p[0] == '12' || p[1] == '11' || p[1] == '12')) {
                          strokeWeight(3);
                          stroke(255, 0, 0);
                          line(x1, y1, x2, y2);
                      } else {
                          strokeWeight(2);
                          stroke('rgb(0, 255, 0)');
                          line(x1, y1, x2, y2);
                      }
                  }
              }
          }
      }

      function updateHipAngle() {
        
        rightShoulder = poses[0].keypoints[6];
        rightHip = poses[0].keypoints[12];
        rightKnee = poses[0].keypoints[14];
        
        leftShoulder = poses[0].keypoints[5];
        leftHip = poses[0].keypoints[11];
        leftKnee = poses[0].keypoints[13];

            leftAngle = (
                Math.atan2(leftShoulder.y - leftHip.y, leftShoulder.x - leftHip.x) -
                Math.atan2(leftKnee.y - leftHip.y, leftKnee.x - leftHip.x)
            ) * (180 / Math.PI);

            // console.log(`left hip`, leftAngle); 
            if ((leftAngle > -170 && leftAngle < -150) || (leftAngle > -80 && leftAngle < -60)) {
                highlightHip = false; 
            } else {
                highlightHip = true; 
                if (!kneeWarningGiven) {
                    var msg = new SpeechSynthesisUtterance('Keep your back straight');
                    window.speechSynthesis.speak(msg);
                    kneeWarningGiven = true;
                }
            }

            if (leftShoulder.score > 0.3 && leftHip.score > 0.3 && leftKnee.score > 0.3) {
              leftAngle = leftAngle;
            }

        // Right arm angle calculation
        rightShoulder = poses[0].keypoints[6];
        rightHip = poses[0].keypoints[12];
        rightKnee = poses[0].keypoints[14];

            rightAngle = (
                Math.atan2(rightShoulder.y - rightHip.y, rightShoulder.x - rightHip.x) -
                Math.atan2(rightKnee.y - rightHip.y, rightKnee.x - rightHip.x)
            ) * (180 / Math.PI);
        
            // console.log(`right hip`, rightAngle); 
            if ((rightAngle <  -175 && rightAngle > -195) || (rightAngle < -255 && rightAngle > -275)) {
                highlightHip = false;
            } else {
                highlightHip = true;
                if (!kneeWarningGiven) {
                    var msg = new SpeechSynthesisUtterance('Keep your back straight');
                    window.speechSynthesis.speak(msg);
                    kneeWarningGiven = true;
                }
            }
            if (rightShoulder.score > 0.3 && rightHip.score > 0.3 && rightKnee.score > 0.3) {
              rightAngle=rightAngle;
            }
        

      }

      function updateKneeAngle() {

        var leftHip = poses[0].keypoints[11];
        var leftKnee = poses[0].keypoints[13];
        var leftAnkle = poses[0].keypoints[15];


            leftKneeAngle = (
                Math.atan2(leftAnkle.y - leftKnee.y, leftAnkle.x - leftKnee.x) -
                Math.atan2(leftKnee.y - leftHip.y, leftKnee.x - leftHip.x)
            ) * (180 / Math.PI);
            // console.log(`left knee`, leftKneeAngle); 

            if ((leftKneeAngle < 10 && leftKneeAngle > -10) || (leftKneeAngle > 110 && leftKneeAngle < 130)) {
                highlightHip = false; 
            } else {
                highlightHip = true; 
                if (!kneeWarningGiven) {
                    var msg = new SpeechSynthesisUtterance('Bend knees and hips simultaneously, lowering hips');
                    window.speechSynthesis.speak(msg);
                    kneeWarningGiven = true;
                }
                if (leftAnkle.score > 0.3 && leftKnee.score > 0.3 && leftHip.score > 0.3) {
                  leftKneeAngle =leftKneeAngle;
                }
        }

        // Right arm angle calculation
        const rightHip = poses[0].keypoints[12];
        const rightKnee = poses[0].keypoints[14];
        const rightAnkle = poses[0].keypoints[16];

            rightKneeAngle = (
                Math.atan2(rightAnkle.y - rightKnee.y, rightAnkle.x - rightKnee.x) -
                Math.atan2(rightKnee.y - rightHip.y, rightKnee.x - rightHip.x)
            ) * (180 / Math.PI);
            // console.log(`right knee`, rightKneeAngle); 

            if ((rightKneeAngle < 10 && rightKneeAngle > -10) || (rightKneeAngle < -90 && rightKneeAngle > -110)) {
                highlightHip = false; 
            } else {
                highlightHip = true; 
                if (!kneeWarningGiven) {
                    var msg = new SpeechSynthesisUtterance('Bend knees and hips simultaneously, lowering hips');
                    window.speechSynthesis.speak(msg);
                    kneeWarningGiven = true;
                }
            }
            if (rightAnkle.score > 0.3 && rightKnee.score > 0.3 && rightHip.score > 0.3) {
              rightKneeAngle = rightKneeAngle;
            }
  
      }

      function inUpPosition() {
            if ((leftAngle > -175 && leftAngle < -155) && (rightAngle <  -175 && rightAngle > -195) && (leftKneeAngle < 10 && leftKneeAngle > -10) && (rightKneeAngle < 10 && rightKneeAngle > -10)) {
            if (downPosition == true) {
                  var msg = new SpeechSynthesisUtterance(str(reps+1));
                  window.speechSynthesis.speak(msg);
                  reps = reps + 1;           
              }
              upPosition = true;
              downPosition = false;
          }
      }

      function inDownPosition() {
          if ((leftAngle > -80 && leftAngle < -60) && (rightAngle < -255 && rightAngle > -275) && (leftKneeAngle > 110 && leftKneeAngle < 130) && (leftKneeAngle > 110 && leftKneeAngle < 130)) {
              if (upPosition == true) {
                  var msg = new SpeechSynthesisUtterance("Up");
                  window.speechSynthesis.speak(msg);   
              }
              upPosition = false;
              downPosition = true;
          }
      }

      const resetButton = document.getElementById('resetButton');
      resetButton.addEventListener('click', () => {
          reps = 0;
      });

    </script>
  </body>
</html>